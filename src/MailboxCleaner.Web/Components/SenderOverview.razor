<h2>Sender overview</h2>

<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Search</label>
                <input class="form-control" @bind="SearchTerm" @bind:event="oninput" placeholder="Search by name or email" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Domain</label>
                <input class="form-control" list="domain-options" @bind="DomainFilter" @bind:event="oninput" placeholder="Type or select domain" />
                <datalist id="domain-options">
                    @foreach (var domain in availableDomains)
                    {
                        <option value="@domain"></option>
                    }
                </datalist>
            </div>
            <div class="col-md-3">
                <label class="form-label">Sort</label>
                <select class="form-select" @bind="SortOption">
                    <option value="@SenderSortOption.CountDesc">Count (desc)</option>
                    <option value="@SenderSortOption.CountAsc">Count (asc)</option>
                    <option value="@SenderSortOption.SenderAsc">Sender (A-Z)</option>
                    <option value="@SenderSortOption.SenderDesc">Sender (Z-A)</option>
                </select>
            </div>
            <div class="col-md-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="noreplyOnly" @bind="NoreplyOnly" />
                    <label class="form-check-label" for="noreplyOnly">Noreply only</label>
                </div>
            </div>
        </div>
        <div class="mt-3 d-flex gap-2">
            <button class="btn btn-outline-primary" @onclick="RefreshAsync" disabled="@isLoading">Refresh</button>
            @if (!string.IsNullOrWhiteSpace(selectedSenderEmail))
            {
                <button class="btn btn-outline-secondary" @onclick="ClearSenderSelection">Clear sender selection</button>
            }
        </div>
    </div>
</div>

@if (isLoading)
{
    <div class="alert alert-info">Loading Gmail metadataâ€¦</div>
}
else if (!filteredSenders.Any())
{
    <div class="alert alert-warning">No senders found.</div>
}
else
{
    <div class="table-responsive mb-4">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Sender</th>
                    <th>Email</th>
                    <th class="text-end">Count</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var sender in filteredSenders)
                {
                    var rowClass = selectedSenderEmail.Equals(sender.Email, StringComparison.OrdinalIgnoreCase)
                        ? "table-primary"
                        : string.Empty;

                    <tr class="@rowClass" role="button" @onclick="() => SelectSender(sender.Email)">
                        <td>@sender.Name</td>
                        <td>@sender.Email</td>
                        <td class="text-end">@sender.Count</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <h3>Mail overview</h3>

    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Subject</label>
                    <input class="form-control" list="subject-options" @bind="SubjectFilter" @bind:event="oninput" placeholder="Type subject" />
                    <datalist id="subject-options">
                        @foreach (var subject in AvailableSubjects)
                        {
                            <option value="@subject"></option>
                        }
                    </datalist>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date</label>
                    <input class="form-control" list="date-options" @bind="DateFilter" @bind:event="oninput" placeholder="YYYY-MM-DD" />
                    <datalist id="date-options">
                        @foreach (var date in AvailableDates)
                        {
                            <option value="@date"></option>
                        }
                    </datalist>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <input class="form-control" list="status-options" @bind="StatusFilter" @bind:event="oninput" placeholder="Read / Unread" />
                    <datalist id="status-options">
                        @foreach (var status in AvailableStatuses)
                        {
                            <option value="@status"></option>
                        }
                    </datalist>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Sender</label>
                    <input class="form-control" list="sender-options" @bind="MessageSenderFilter" @bind:event="oninput" placeholder="Type sender" />
                    <datalist id="sender-options">
                        @foreach (var sender in AvailableMessageSenders)
                        {
                            <option value="@sender"></option>
                        }
                    </datalist>
                </div>
            </div>
        </div>
    </div>

    @if (!filteredMessages.Any())
    {
        <div class="alert alert-warning">No messages match the selected filters.</div>
    }
    else
    {
        <p class="text-muted">Selected messages: @selectedMessageIds.Count</p>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th></th>
                        <th>Subject</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Sender</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var message in filteredMessages)
                    {
                        <tr>
                            <td>
                                <input type="checkbox"
                                       checked="@selectedMessageIds.Contains(message.Id)"
                                       @onchange="(args) => ToggleMessageSelection(message.Id, args)" />
                            </td>
                            <td>@message.Subject</td>
                            <td>@(message.ReceivedAt?.ToString("yyyy-MM-dd HH:mm") ?? "Unknown")</td>
                            <td>@(message.IsRead ? "Read" : "Unread")</td>
                            <td>@message.SenderEmail</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
}

@code {
    private bool isLoading = true;
    private string searchTerm = string.Empty;
    private string domainFilter = string.Empty;
    private bool noreplyOnly;
    private SenderSortOption sortOption = SenderSortOption.CountDesc;
    private List<SenderStatDto> allSenders = new();
    private List<SenderStatDto> filteredSenders = new();
    private List<string> availableDomains = new();

    private List<MailItemDto> allMessages = new();
    private List<MailItemDto> filteredMessages = new();
    private readonly HashSet<string> selectedMessageIds = new(StringComparer.OrdinalIgnoreCase);

    private string selectedSenderEmail = string.Empty;
    private string subjectFilter = string.Empty;
    private string dateFilter = string.Empty;
    private string statusFilter = string.Empty;
    private string messageSenderFilter = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await RefreshAsync();
    }

    private async Task RefreshAsync()
    {
        isLoading = true;
        StateHasChanged();

        var query = new GetSenderOverviewQuery();
        allSenders = (await OverviewService.GetOverviewAsync(query, CancellationToken.None)).ToList();
        allMessages = (await OverviewService.GetMailItemsAsync(CancellationToken.None)).ToList();

        availableDomains = allSenders.Select(s => s.Domain)
            .Where(domain => !string.IsNullOrWhiteSpace(domain))
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(domain => domain)
            .ToList();

        ApplyFilters();
        isLoading = false;
    }

    private void ApplyFilters()
    {
        IEnumerable<SenderStatDto> senderResults = allSenders;

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            senderResults = senderResults.Where(sender =>
                sender.Email.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                sender.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(domainFilter))
        {
            senderResults = senderResults.Where(sender => sender.Domain.Contains(domainFilter, StringComparison.OrdinalIgnoreCase));
        }

        if (noreplyOnly)
        {
            senderResults = senderResults.Where(sender => sender.Email.Contains("noreply", StringComparison.OrdinalIgnoreCase));
        }

        senderResults = sortOption switch
        {
            SenderSortOption.CountAsc => senderResults.OrderBy(sender => sender.Count),
            SenderSortOption.SenderAsc => senderResults.OrderBy(sender => sender.Email),
            SenderSortOption.SenderDesc => senderResults.OrderByDescending(sender => sender.Email),
            _ => senderResults.OrderByDescending(sender => sender.Count)
        };

        filteredSenders = senderResults.ToList();

        IEnumerable<MailItemDto> messageResults = allMessages;

        if (!string.IsNullOrWhiteSpace(selectedSenderEmail))
        {
            messageResults = messageResults.Where(message => message.SenderEmail.Equals(selectedSenderEmail, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(messageSenderFilter))
        {
            messageResults = messageResults.Where(message => message.SenderEmail.Contains(messageSenderFilter, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(subjectFilter))
        {
            messageResults = messageResults.Where(message => message.Subject.Contains(subjectFilter, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(dateFilter))
        {
            messageResults = messageResults.Where(message =>
                message.ReceivedAt?.ToString("yyyy-MM-dd").Contains(dateFilter, StringComparison.OrdinalIgnoreCase) == true);
        }

        if (!string.IsNullOrWhiteSpace(statusFilter))
        {
            var normalized = statusFilter.Trim();
            if (normalized.StartsWith("un", StringComparison.OrdinalIgnoreCase))
            {
                messageResults = messageResults.Where(message => !message.IsRead);
            }
            else if (normalized.StartsWith("re", StringComparison.OrdinalIgnoreCase))
            {
                messageResults = messageResults.Where(message => message.IsRead);
            }
        }

        filteredMessages = messageResults
            .OrderByDescending(message => message.ReceivedAt)
            .ToList();

        selectedMessageIds.RemoveWhere(id => filteredMessages.All(message => !message.Id.Equals(id, StringComparison.OrdinalIgnoreCase)));
    }

    private IEnumerable<string> AvailableSubjects => filteredMessages
        .Select(message => message.Subject)
        .Where(subject => !string.IsNullOrWhiteSpace(subject))
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .OrderBy(subject => subject)
        .Take(25);

    private IEnumerable<string> AvailableDates => filteredMessages
        .Where(message => message.ReceivedAt.HasValue)
        .Select(message => message.ReceivedAt!.Value.ToString("yyyy-MM-dd"))
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .OrderByDescending(date => date)
        .Take(25);

    private static IReadOnlyList<string> AvailableStatuses { get; } = ["Read", "Unread"];

    private IEnumerable<string> AvailableMessageSenders => filteredMessages
        .Select(message => message.SenderEmail)
        .Where(sender => !string.IsNullOrWhiteSpace(sender))
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .OrderBy(sender => sender)
        .Take(25);

    private void SelectSender(string email)
    {
        selectedSenderEmail = email;
        messageSenderFilter = email;
        ApplyFilters();
    }

    private void ClearSenderSelection()
    {
        selectedSenderEmail = string.Empty;
        messageSenderFilter = string.Empty;
        ApplyFilters();
    }

    private void ToggleMessageSelection(string messageId, ChangeEventArgs args)
    {
        var isSelected = args.Value is bool boolValue && boolValue;
        if (isSelected)
        {
            selectedMessageIds.Add(messageId);
        }
        else
        {
            selectedMessageIds.Remove(messageId);
        }
    }

    private string SearchTerm
    {
        get => searchTerm;
        set
        {
            searchTerm = value;
            ApplyFilters();
        }
    }

    private string DomainFilter
    {
        get => domainFilter;
        set
        {
            domainFilter = value;
            ApplyFilters();
        }
    }

    private bool NoreplyOnly
    {
        get => noreplyOnly;
        set
        {
            noreplyOnly = value;
            ApplyFilters();
        }
    }

    private SenderSortOption SortOption
    {
        get => sortOption;
        set
        {
            sortOption = value;
            ApplyFilters();
        }
    }

    private string SubjectFilter
    {
        get => subjectFilter;
        set
        {
            subjectFilter = value;
            ApplyFilters();
        }
    }

    private string DateFilter
    {
        get => dateFilter;
        set
        {
            dateFilter = value;
            ApplyFilters();
        }
    }

    private string StatusFilter
    {
        get => statusFilter;
        set
        {
            statusFilter = value;
            ApplyFilters();
        }
    }

    private string MessageSenderFilter
    {
        get => messageSenderFilter;
        set
        {
            messageSenderFilter = value;
            ApplyFilters();
        }
    }
}
